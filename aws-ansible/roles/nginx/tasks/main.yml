#===============================================================================
# roles/nginx/tasks/main.yml - Nginx 설치 및 설정
#===============================================================================
# 역할: Nginx 리버스 프록시 설정
# Phase 1 참조:
#   - Nginx 설정: /etc/nginx/conf.d/wildfly-proxy.conf
#   - SELinux: httpd_can_network_connect=1 필수
#===============================================================================

---
#---------------------------------------
# Nginx 설치
#---------------------------------------
- name: Install Nginx
  ansible.builtin.dnf:
    name: nginx
    state: present
  tags: nginx

#---------------------------------------
# SELinux 설정 (중요!)
#---------------------------------------
# Phase 1 TSR-AWS-008: ALB 502 오류 해결
# Nginx가 외부(Internal ALB)로 네트워크 연결하려면 필수
- name: Enable SELinux httpd_can_network_connect
  ansible.posix.seboolean:
    name: httpd_can_network_connect
    state: true
    persistent: true
  tags:
    - nginx
    - selinux

#---------------------------------------
# 기본 설정 백업
#---------------------------------------
- name: Backup default nginx.conf
  ansible.builtin.copy:
    src: /etc/nginx/nginx.conf
    dest: /etc/nginx/nginx.conf.bak
    remote_src: true
    force: false  # 이미 있으면 덮어쓰지 않음
  tags: nginx

#---------------------------------------
# Proxy 설정 파일 배포
#---------------------------------------
- name: Deploy Nginx proxy configuration
  ansible.builtin.template:
    src: wildfly-proxy.conf.j2
    dest: /etc/nginx/conf.d/wildfly-proxy.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload Nginx
  tags: nginx

#---------------------------------------
# 기본 server block 비활성화
#---------------------------------------
# default.conf가 있으면 충돌 방지를 위해 이동
- name: Check if default.conf exists
  ansible.builtin.stat:
    path: /etc/nginx/conf.d/default.conf
  register: default_conf
  tags: nginx

- name: Disable default server block
  ansible.builtin.command:
    cmd: mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled
  when: default_conf.stat.exists
  tags: nginx

#---------------------------------------
# Nginx 설정 검증
#---------------------------------------
- name: Test Nginx configuration
  ansible.builtin.command:
    cmd: nginx -t
  register: nginx_test
  changed_when: false
  tags: nginx

- name: Display Nginx config test result
  ansible.builtin.debug:
    msg: "{{ nginx_test.stderr_lines }}"
  tags: nginx

#---------------------------------------
# Nginx 서비스 시작 및 활성화
#---------------------------------------
- name: Start and enable Nginx
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: true
  tags: nginx
